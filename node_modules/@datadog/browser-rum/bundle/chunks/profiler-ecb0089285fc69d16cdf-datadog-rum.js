(self.webpackChunk_datadog_browser_rum=self.webpackChunk_datadog_browser_rum||[]).push([["profiler"],{219(e,t,n){n.r(t),n.d(t,{DEFAULT_RUM_PROFILER_CONFIGURATION:()=>m,createRumProfiler:()=>v});var s=n(197),i=n(749),o=n(61),r=n(315),a=n(875),l=n(636),c=n(506);const u=new Map;function p(e){for(const t of u.keys())t<e&&u.delete(t)}var d=n(534);const f={sendProfile(e,t,n,s){const o=function(e,t,n,s){const o=t.tags,r=function(e,t,n){const s={application:{id:t}};n&&(s.session={id:n});const i=Array.from(new Set(e.views.map((e=>e.viewId))));i.length&&(s.view={id:i});const o=e.longTasks.map((e=>e.id)).filter((e=>void 0!==e));return o.length&&(s.long_task={id:o}),s}(e,n,s),a=function(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}(o);return{...r,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:a.join(","),_dd:{clock_drift:(0,i.TP)()}}}(e,t,n,s),r=function(e,t){const n=new Blob([JSON.stringify(e)],{type:"application/json"}),s=new FormData;return s.append("event",new Blob([JSON.stringify(t)],{type:"application/json"}),"event.json"),s.append("wall-time.json",n,"wall-time.json"),{data:s,bytesCount:0}}(e,o),a=t.build("fetch",r);return(0,d.A2)("Sending profile to public profiling intake",{profilingIntakeURL:a,applicationId:n,sessionId:s}),fetch(a,{body:r.data,method:"POST"})}},m={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function v(e,t,n,d=m){const v=(0,c.s5)(c.do.LONG_ANIMATION_FRAME);let g;const k=[];let w={state:"stopped"};function b(){const n=(0,o.V)().Profiler;if(!n)throw Error("RUM Profiler is not supported in this browser.");h(w).catch(r.Dx);const{cleanupTasks:s,observer:c}=function(n){if("running"===n.state)return{cleanupTasks:n.cleanupTasks,observer:n.observer};const s=[];let i;if(e.trackLongTasks){i=new PerformanceObserver(M),i.observe({entryTypes:[v?"long-animation-frame":"longtask"]});const e=t.subscribe(12,(e=>{!function({rawRumEvent:e,startTime:t}){"long_task"===e.type&&function(e,t){u.set(t,e)}(e.long_task.id,t)}(e)}));s.push((()=>null==i?void 0:i.disconnect())),s.push(e.unsubscribe)}const o=t.subscribe(2,(e=>{I({viewId:e.id,viewName:e.name,startClocks:e.startClocks})}));return s.push(o.unsubscribe),{cleanupTasks:s,observer:i}}(w);let p;try{p=new n({sampleInterval:d.sampleIntervalMs,maxBufferSize:Math.round(1.5*d.collectIntervalMs/d.sampleIntervalMs)})}catch(e){return void a.Vy.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",e)}w={state:"running",startClocks:(0,i.M8)(),profiler:p,timeoutId:(0,l.wg)(b,d.collectIntervalMs),longTasks:[],views:[],cleanupTasks:s,observer:c},I(g),p.addEventListener("samplebufferfull",T)}async function h(t){var s,o;if("running"!==t.state)return;S(null!==(o=null===(s=t.observer)||void 0===s?void 0:s.takeRecords())&&void 0!==o?o:[]),(0,l.DJ)(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",T);const{startClocks:a,longTasks:c,views:u}=t,m=(0,i.M8)();await t.profiler.stop().then((t=>{const s=(0,i.M8)(),o=c.length>0,l=(0,i.vk)(a.timeStamp,s.timeStamp)<d.minProfileDurationMs,v=function(e){let t=0;for(const n of e)void 0!==n.stackId&&t++;return t}(t.samples)<d.minNumberOfSamples;(o||!l&&!v)&&(function(t){var s;const i=null===(s=n.findTrackedSession())||void 0===s?void 0:s.id;f.sendProfile(t,e.profilingEndpointBuilder,e.applicationId,i).catch(r.Dx)}(Object.assign(t,{startClocks:a,endClocks:s,clocksOrigin:(0,i.Oc)(),longTasks:c,views:u,sampleInterval:d.sampleIntervalMs})),p(m.relative))})).catch(r.Dx)}async function y(e){"running"===w.state&&(w.cleanupTasks.forEach((e=>e())),await h(w),w={state:e})}function I(e){"running"===w.state&&e&&w.views.push(e)}function T(){b()}function M(e){S(e.getEntries())}function S(e){var t;if("running"===w.state)for(const n of e){if(n.duration<d.sampleIntervalMs)continue;const e=(0,i.FR)(n.startTime),s=(t=e.relative,u.get(t));w.longTasks.push({id:s,duration:n.duration,entryType:n.entryType,startClocks:e})}}function _(){"hidden"===document.visibilityState&&"running"===w.state?y("paused").catch(r.Dx):"visible"===document.visibilityState&&"paused"===w.state&&b()}function O(){b()}return{start(t){"running"!==w.state&&(g=t?{startClocks:t.startClocks,viewId:t.id,viewName:t.name}:void 0,k.push((0,s.q)(e,window,"visibilitychange",_).stop,(0,s.q)(e,window,"beforeunload",O).stop),b())},async stop(){await y("stopped"),k.forEach((e=>e())),p((0,i.M8)().relative)},isStopped:()=>"stopped"===w.state,isRunning:()=>"running"===w.state,isPaused:()=>"paused"===w.state}}}}]);